trigger: none

pool:
  vmImage: ubuntu-latest

jobs:
- job: Docker
  condition: eq(variables['docker.enabled'], 'true')
  variables:
    DOCKER_BUILDKIT: 1
    DOCKER_REPOSITORY: zcorp-consumer
  steps:
  - task: Docker@2
    displayName: Login
    inputs:
      command: login
      containerRegistry: $(docker.containerRegistry)
  - task: Docker@2
    displayName: Build Initial
    inputs:
      command: build
      repository: $(DOCKER_REPOSITORY)-build
      tags: latest
      arguments: --target build
  - script: |
      set -e
      docker run --name test $(docker.containerRegistry)/$(DOCKER_REPOSITORY)-build npm test -- --coverage --coverageReporters=cobertura
      docker cp test:/app $(Build.ArtifactStagingDirectory)/app
      docker rm test
      sed -i "s|<source>/app</source>|<source>$(Build.ArtifactStagingDirectory)/app</source>|g" $(Build.ArtifactStagingDirectory)/app/coverage/cobertura-coverage.xml
    displayName: Test
  - task: PublishCodeCoverageResults@1
    condition: succeededOrFailed()
    displayName: Publish Code Coverage Results
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: $(Build.ArtifactStagingDirectory)/app/coverage/cobertura-coverage.xml
  - task: Docker@2
    displayName: Build Final and Push
    inputs:
      command: buildAndPush
      repository: $(DOCKER_REPOSITORY)
      tags: |
        $(Build.BuildId)
        latest